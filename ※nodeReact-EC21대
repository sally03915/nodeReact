### NODE + REACT AWS  ( EC2 - 1ê°œ VER  :  node 3065 / react 3000 )
---

##### 1. [back] ì½”ë“œìˆ˜ì • - app.js ì½”ë“œìˆ˜ì •

**[full source]**

```bash
////1. require
const express = require('express');  // express í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•´ ì„œë²„ ìƒì„±
const cors = require('cors');  // CORS(Cross-Origin Resource Sharing)ë¥¼ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œì˜ API ìš”ì²­ì„ í—ˆìš©
const session = require('express-session');
const cookieParser = require('cookie-parser'); //ì¿ í‚¤ì™€ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ì—¬ ì‚¬ìš©ìì˜ ì¸ì¦ ë° ìƒíƒœë¥¼ ìœ ì§€
const passport = require('passport');  //ì¿ í‚¤ì™€ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ì—¬ ì‚¬ìš©ìì˜ ì¸ì¦ ë° ìƒíƒœë¥¼ ìœ ì§€
const dotenv = require('dotenv');  // í™˜ê²½ë³€ìˆ˜ .env ë¥¼ ë¡œë“œí•˜ì—¬ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ ë³´í˜¸í•¨.
const morgan = require('morgan');  // ë¸Œë¼ìš°ì € ë¡œê·¸ì¸ ì²˜ë¦¬
const path = require('path');
const postRouter = require('./routes/post');
const postsRouter = require('./routes/posts');
const userRouter = require('./routes/user');
const hashtagRouter = require('./routes/hashtag');  // ë¼ìš°í„° ì—°ê²°
const db = require('./models');
const passportConfig = require('./passport');

//#####
const hpp = require('hpp');
const helmet = require('helmet');

////2. í™˜ê²½ì„¤ì •
dotenv.config();  //í™˜ê²½ì„¤ì • .env ë¥¼ ë¡œë“œ
const app = express();

////3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
db.sequelize.sync()
    .then(() => {
        console.log('db ì—°ê²° ì„±ê³µ');
    })
    .catch(console.error);
passportConfig();  //

/////4. ê°ì¢…ì‚¬ìš© ì—°ê²°

if (process.env.NODE_ENV === 'production') { //// ë°°í¬ìš©
    app.set('trust proxy', 1);  //##
    app.use(morgan('combined'));
    app.use(hpp());
    app.use(helmet({ contentSecurityPolicy: false }));
    app.use(cors({
        //origin: 'http://d2big.com',
        origin: 'http://13.209.81.237',  // ìš”ì²­í—ˆìš©  ###########
        credentials: true,
    }));
} else {  //// ê°œë°œìš©
    app.use(morgan('dev'));  // httpìš”ì²­ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ì—¬ ë””ë²„ê¹…ê³¼ ëª¨ë‹ˆí„°ë§
    app.use(cors({
        origin: 'http://localhost:3000',  // ìš”ì²­í—ˆìš©
        credentials: true,  // ì¿ í‚¤ì™€ ê°™ì€ ì¸ì¦ì •ë³´ë¥´ í¬í•¨í•œ ìš”ì²­ë„ í—ˆìš©
    }));

}

app.use('/images', express.static(path.join(__dirname, 'uploads')));   // uploads ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ì„  ì•¡ì„¸ìŠ¤í• ìˆ˜ ìˆê²Œ
app.use(express.json());  // ìš”ì²­ë³¸ë¬¸ì„ íŒŒì‹±í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ - í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° json ë°ì´í„°ë¥¼ ë°›ì„ ë•Œ ì‚¬ìš©ë¨.
app.use(express.urlencoded({ extended: true }));  // url ìš”ì²­ë³¸ë¬¸ì„ íŒŒì‹±í•¨.
app.use(cookieParser(process.env.COOKIE_SECRET)); // ì¿ í‚¤ë¥¼ íŒŒì‹±í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´
// ì„¸ì…˜ê´€ë¦¬ë¥¼ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´

if (process.env.NODE_ENV === 'production') { //// ë°°í¬ìš©
    app.use(session({
        saveUninitialized: false,  // ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ì„¸ì…˜ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ.
        resave: false,  // ì„¸ì…˜ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ.
        secret: process.env.COOKIE_SECRET,  // ì„¸ì…˜ë°ì´í„¸ë¥´ ì•”í˜¸í™”í•˜ê¸°ìœ„í•œ ë¹„ë°€í‚¤
        proxy: true, //##
        cookie: {
            httpOnly: true,
            secure:false
           // secure: true,  //##
           // domain: process.env.NODE_ENV === 'production' && '.d2big.com'
        },
    }));

} else {
    app.use(session({
        saveUninitialized: false,  // ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ì„¸ì…˜ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ.
        resave: false,  // ì„¸ì…˜ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ.
        secret: process.env.COOKIE_SECRET,  // ì„¸ì…˜ë°ì´í„¸ë¥´ ì•”í˜¸í™”í•˜ê¸°ìœ„í•œ ë¹„ë°€í‚¤
        cookie: { secure: false } // productionì—ì„œëŠ” trueë¡œ ì„¤ì •
    }));
}
app.use(passport.initialize());  // passport ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ , passportëŠ” ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
app.use(passport.session()); // ì‚¬ìš©ìì˜ ì¸ì¦ìƒíƒœë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ê³  ìš”ì²­ê°„ì— ìœ ì§€

app.get('/', (req, res) => {
    res.send('hello express');
});
// APIëŠ” ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ ë‚´ ì„œë¹„ìŠ¤ì˜ ê¸°ëŠ¥ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ì—´ì–´ë‘” ì°½êµ¬
////5. ë¼ìš°íŒ… - ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë¼ìš°í„°ë¥¼ ì—°ê²°
app.use('/posts', postsRouter);
app.use('/post', postRouter);
app.use('/user', userRouter);
app.use('/hashtag', hashtagRouter); //##

////6. ì„œë²„ì„¤ì • ë° ì‹¤í–‰
app.listen(3065, () => {
    console.log('ì„œë²„ ì‹¤í–‰ ì¤‘!');
});

```

##### 2. [BACK] sshë¥¼ ì´ìš©í•˜ì—¬ ì—°ê²°í•˜ì—¬ gitíŒŒì¼ë‹¤ìš´ë¡œë“œ

```bash
1. [vs code] - sshë¡œ ì ‘ì†
ssh -i "back.pem" ubuntu@ec2-43-201-96-81.ap-northeast-2.compute.amazonaws.com
  yes

2. githubì—ì„œ clone
git clone https://github.com/sally03915/nodeReact.git
ls
```

```bash
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
sudo swapon --show
sudo free -h
```

##### 3. ë…¸ë“œì„¤ì¹˜

1. ë…¸ë“œ ì„¤ì¹˜í•˜ê¸°

```bash
   cd back    //back ìˆëŠ” ê²½ë¡œë¡œ ì´ë™
   sudo apt-get update
   sudo apt-get install -y build-essential     // ì–´ë–¤ì˜µì…˜ì´ ë‚˜ì˜¤ë©´ -   Tab í‚¤ë¥¼ ëˆŒëŸ¬ <Ok> ë²„íŠ¼ìœ¼ë¡œ ì´ë™
   sudo apt-get install curl
   sudo apt-get install nodejs -y

```

##### 4. mysql ì„¤ì¹˜í•˜ê¸°

```bash
   1. ì„¤ì¹˜í• ìˆ˜ ìˆëŠ” mysqlë²„ì ¼
      sudo apt-cache search mysql-server
   2. apt ì—…ë°ì´íŠ¸
      sudo apt-get update
   3. mysqlì„¤ì¹˜ - mysql-server8.0
      sudo apt-get install mysql-server-8.0
   4. mysqlì ‘ì†
      /etc/init.d/mysql status
      sudo mysql -uroot ë¹„ë²ˆì—†ìŒ
   5. ì¸ì¦í™•ì¸
      select user, host, plugin from mysql.user;
   6. ì¸ì¦ì—…ë°ì´íŠ¸
      use mysql
      UPDATE user SET plugin='caching_sha2_password' WHERE user='root';
      flush privileges;
   7. ë¹„ë²ˆë°”ê¾¸ê¸°
      SET password for 'root'@'localhost'='1234';
   8. í™•ì¸
      mysql -uroot -p
      1234
   9. dbë§Œë“¤ê¸°
      create database node_react;
```

##### 5. npx sequelize db:create

```bash
sudo apt install npm   // ì˜ ì„¤ì¹˜ê°€ ì•ˆë˜ì—ˆë‹¤ë©´
sudo npm i
sudo npx sequelize db:create
```

```bash
- mysql ì— ì ‘ì†í›„ show tables í•´ì„œ í…Œì´ë¸”ëª… í™•ì¸í•  ê²ƒ.
```

mysql> use node_react
Database changed
mysql>
mysql>
mysql> show tables;
+----------------------+
| Tables_in_node_react |
+----------------------+
| Follow |
| Like |
| Posthashtag |
| comments |
| hashtags |
| images |
| posts |
| users |
+----------------------+
8 rows in set (0.00 sec)

##### 6. pm2

- ì‹¤í–‰ì€ ë‚˜ì¤‘ì— í• ê²ƒ.

```bash
sudo npm i pm2  cross-env  helmet hpp
```

<br/>
<br/>

##### 7. public ipë¡œ ì ‘ì†í•´ë³´ê¸°

1.  íƒ„ë ¥ì  ip ì„¤ì •
2.  public ipë¡œ ì ‘ì†

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

---

#### â–  PART002. EC2 ì˜¬ë¦¬ê¸° - FRONT

##### 1. ì½”ë“œë³€ê²½

1. [front]- [config]-config.js

- back public ipë¡œ ë³€ê²½

```
process.env.NODE_ENV === 'production' ? 'http://43.201.96.81' : 'http://localhost:3065';
```

                                        #########

> ã…ì¶”í›„ domain ì—°ê²°í›„

```
process.env.NODE_ENV === 'production' ? 'https://d2big.com' : 'http://localhost:3065';
```

<br/>
<br/>

2. [front]- [sagas]- index.js

```
axios.defaults.baseURL = backUrl;
axios.defaults.withCredentials = true;
```

<br/>
<br/>

3. [front] - package.json

```bash
"dev": "next -p 3000",
"build": "cross-env ANALYZE=false NODE_ENV=production next build",
"start": "cross-env NODE_ENV=production next start -p 3000"
```

â€» ì°¸ê³  - íŒŒì¼ ìˆ˜ì • í›„ ë‹¤ì‹œ ë°›ì„ë•Œ

```bash
git pull    origin main
git reset --hard origin/main     // ê°•ì œì ìš©
```

##### 2. [FRONT] ë…¸ë“œ ì„¤ì¹˜í•˜ê¸°

```bash
sudo  apt-get  update
sudo  apt-get  install  -y  build-essential
sudo  apt-get  install  curl
sudo  apt-get  install nodejs  -y
sudo  apt-get  install npm

node -v
npm  -v

sudo npm install          --legacy-peer-deps
```

##### 3. build

```bash
sudo npm install react-is
```

```bash
sudo npm run build
```

ğŸš€ ì¼ë°˜ì ì¸ Next.js í”„ë¡œì íŠ¸ (50~100 í˜ì´ì§€) â†’ 1~5ë¶„
âš¡ ëŒ€í˜• í”„ë¡œì íŠ¸ (1000+ í˜ì´ì§€, ë³µì¡í•œ ì´ë¯¸ì§€ ìµœì í™” í¬í•¨) â†’ 5~15ë¶„ ì´ìƒ

â€» ì°¸ê³  - íŒŒì¼ ìˆ˜ì • í›„ ë‹¤ì‹œ ë°›ì„ë•Œ

```bash
git pull    origin main
git reset --hard origin/main     // ê°•ì œì ìš©
```

##### 4. pm2

```bash
sudo npm install pm2 --legacy-peer-deps
```

<br/>
<br/>
<br/>

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

---

#### â–  PART003. nginx

##### 1. nginx ?

```bash
sudo su
sudo lsof -i tcp:80
(ë‚˜ì˜¤ëŠ” ê°’ì´ ì—†ì–´ì•¼ í•¨, ë‚˜ì˜¨ë‹¤ë©´ sudo kill -9 í”„ë¡œì„¸ìŠ¤ì•„ì´ë””(PID))
```

```bash
sudo apt-get install -y nginx
```

```bash
sudo rm /etc/nginx/sites-available/default
sudo rm /etc/nginx/sites-enabled/default
```

```bash
cd /etc/nginx/sites-available
sudo vi proxy.conf
```

```bash
server {
    listen 80;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
    }

    location ~ ^/(user|post|posts|hashtag|images) {
        proxy_pass http://localhost:3065;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
    }
}
```

~ ì •ê·œí‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤ (^ ê°™ì€ íŒ¨í„´ì´ ë“¤ì–´ê°ˆ ë•Œ í•„ìš”)
^/() ìš”ì²­ URLì´ /ë¡œ ì‹œì‘í•˜ê³  ì•ˆì˜ ë‚´ìš©(posts ë“±)ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸

```bash
sudo ln -s /etc/nginx/sites-available/proxy.conf /etc/nginx/sites-enabled/proxy.conf
```

```bash
sudo nginx -t

```

```bash
sudo service nginx restart
```

##### 2.

```bash
sudo npm start && sudo npx pm2

npx pm2 logs
npx pm2 kill
sudo npx pm2 list
sudo npx pm2 reload all
sudo npx pm2 stop app

sudo lsof -i tcp:3065
sudo lsof -i tcp:80
```

```bash
sudo chown ubuntu:ubuntu uploads
sudo chmod 755 uploads
```
